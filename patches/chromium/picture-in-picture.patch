From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Heilig Benedek <benecene@gmail.com>
Date: Sat, 10 Aug 2019 00:41:50 +0200
Subject: feat: enable picture in picture mode for video players

These files are needed to implement PiP, but the Electron build patches out
chrome's generated resources for our own. This updates the #include so that we
don't get errors for Chrome's generated resources, which are non-existent
because we don't generate them in our build.

diff --git a/chrome/browser/ui/views/overlay/close_image_button.cc b/chrome/browser/ui/views/overlay/close_image_button.cc
index a7a637438116a1c7846194dea4412100a45c9331..bb3877d546bfea141d3d6ebb396b88faab6ee34e 100644
--- a/chrome/browser/ui/views/overlay/close_image_button.cc
+++ b/chrome/browser/ui/views/overlay/close_image_button.cc
@@ -4,9 +4,12 @@
 
 #include "chrome/browser/ui/views/overlay/close_image_button.h"
 
+#include "build/branding_buildflags.h"
 #include "chrome/browser/ui/color/chrome_color_id.h"
 #include "chrome/grit/generated_resources.h"
+#if BUILDFLAG(GOOGLE_CHROME_BRANDING)
 #include "components/vector_icons/vector_icons.h"
+#endif  // BUILDFLAG(GOOGLE_CHROME_BRANDING)
 #include "ui/base/l10n/l10n_util.h"
 #include "ui/base/metadata/metadata_impl_macros.h"
 #include "ui/base/models/image_model.h"
@@ -27,7 +30,10 @@ CloseImageButton::CloseImageButton(PressedCallback callback)
     : OverlayWindowImageButton(std::move(callback)) {
   SetSize(gfx::Size(kCloseButtonSize, kCloseButtonSize));
 
-  auto* icon = &vector_icons::kCloseChromeRefreshIcon;
+  auto* icon = &views::kIcCloseIcon;
+#if BUILDFLAG(GOOGLE_CHROME_BRANDING)
+  icon = &vector_icons::kCloseChromeRefreshIcon;
+#endif  // BUILDFLAG(GOOGLE_CHROME_BRANDING)
   SetImageModel(views::Button::STATE_NORMAL,
                 ui::ImageModel::FromVectorIcon(*icon, kColorPipWindowForeground,
                                                kCloseButtonIconSize));
diff --git a/chrome/browser/ui/views/overlay/video_overlay_window_views.cc b/chrome/browser/ui/views/overlay/video_overlay_window_views.cc
index 6cfeed24487c026d13034b5ea7a8fb275bff4006..213926339722055dac339416584f6f60d7018e0c 100644
--- a/chrome/browser/ui/views/overlay/video_overlay_window_views.cc
+++ b/chrome/browser/ui/views/overlay/video_overlay_window_views.cc
@@ -18,12 +18,16 @@
 #include "base/time/time.h"
 #include "base/timer/timer.h"
 #include "build/build_config.h"
+#if 0
 #include "chrome/browser/media/media_engagement_service.h"
+#endif
 #include "chrome/browser/picture_in_picture/picture_in_picture_occlusion_tracker.h"
 #include "chrome/browser/picture_in_picture/picture_in_picture_window_manager.h"
+#if 0
 #include "chrome/browser/profiles/profile.h"
 #include "chrome/browser/ui/browser.h"
 #include "chrome/browser/ui/browser_finder.h"
+#endif
 #include "chrome/browser/ui/color/chrome_color_id.h"
 #include "chrome/browser/ui/views/overlay/back_to_tab_button.h"
 #include "chrome/browser/ui/views/overlay/back_to_tab_label_button.h"
@@ -32,8 +36,10 @@
 #include "chrome/browser/ui/views/overlay/hang_up_button.h"
 #include "chrome/browser/ui/views/overlay/minimize_button.h"
 #include "chrome/browser/ui/views/overlay/overlay_controls_fade_animation.h"
+#if 0
 #include "chrome/browser/ui/views/overlay/overlay_window_live_caption_button.h"
 #include "chrome/browser/ui/views/overlay/overlay_window_live_caption_dialog.h"
+#endif
 #include "chrome/browser/ui/views/overlay/playback_image_button.h"
 #include "chrome/browser/ui/views/overlay/resize_handle_button.h"
 #include "chrome/browser/ui/views/overlay/simple_overlay_window_image_button.h"
@@ -79,7 +85,7 @@
 #include "ui/aura/window.h"
 #endif
 
-#if BUILDFLAG(IS_WIN)
+#if 0
 #include "chrome/browser/shell_integration_win.h"
 #include "content/public/browser/render_widget_host_view.h"
 #include "ui/aura/window.h"
@@ -409,7 +415,7 @@ std::unique_ptr<VideoOverlayWindowViews> VideoOverlayWindowViews::Create(
   overlay_window->Init(std::move(params));
   overlay_window->OnRootViewReady();
 
-#if BUILDFLAG(IS_WIN)
+#if 0
   std::wstring app_user_model_id;
   Browser* browser = chrome::FindBrowserWithTab(controller->GetWebContents());
   if (browser) {
@@ -702,6 +708,7 @@ void VideoOverlayWindowViews::OnMouseEvent(ui::MouseEvent* event) {
     }
 
     case ui::EventType::kMousePressed:
+#if 0
       // Hide the live caption dialog if it's visible and the user clicks
       // outside of it.
       if (live_caption_dialog_ && live_caption_dialog_->GetVisible() &&
@@ -710,6 +717,7 @@ void VideoOverlayWindowViews::OnMouseEvent(ui::MouseEvent* event) {
         SetLiveCaptionDialogVisibility(false);
         return;
       }
+#endif
       break;
 
     default:
@@ -1221,7 +1229,7 @@ void VideoOverlayWindowViews::SetUpViews() {
   live_status->SetBackground(
       views::CreateRoundedRectBackground(ui::kColorSysOnTonalContainer, 4));
   live_status->SetVisible(false);
-
+#if 0
   auto live_caption_button = std::make_unique<OverlayWindowLiveCaptionButton>(
       base::BindRepeating(&VideoOverlayWindowViews::OnLiveCaptionButtonPressed,
                           base::Unretained(this)));
@@ -1232,7 +1240,7 @@ void VideoOverlayWindowViews::SetUpViews() {
       Profile::FromBrowserContext(
           controller_->GetWebContents()->GetBrowserContext()));
   live_caption_dialog->SetVisible(false);
-
+#endif
   auto toggle_microphone_button =
       std::make_unique<ToggleMicrophoneButton>(base::BindRepeating(
           [](VideoOverlayWindowViews* overlay) {
@@ -1272,7 +1280,6 @@ void VideoOverlayWindowViews::SetUpViews() {
   video_view->layer()->SetName("VideoView");
 
   // views::View that holds the scrim, which appears with the controls. -------
-  controls_scrim_view->SetPaintToLayer(ui::LAYER_SOLID_COLOR);
   controls_scrim_view->layer()->SetName("ControlsScrimView");
 
   // views::View that is a parent of all the controls. Makes hiding and showing
@@ -1322,77 +1329,9 @@ void VideoOverlayWindowViews::SetUpViews() {
   minimize_button->layer()->SetFillsBoundsOpaquely(false);
   minimize_button->layer()->SetName("OverlayWindowMinimizeButton");
 
+#if BUILDFLAG(IS_CHROMEOS)
   // views::View that closes the window and focuses initiator tab. ----------
   back_to_tab_button->SetPaintToLayer(ui::LAYER_TEXTURED);
-  back_to_tab_button->layer()->SetFillsBoundsOpaquely(false);
-  back_to_tab_button->layer()->SetName("BackToTabControlsView");
-
-  // views::View that displays the window title. The window title consists of
-  // the origin and favicon. Always displayed together with the controls top
-  // scrim view.
-  title_view->SetPaintToLayer(ui::LAYER_TEXTURED);
-  title_view->layer()->SetFillsBoundsOpaquely(false);
-  title_view->layer()->SetName("TitleView");
-
-  // views::View that holds the previous-track image button. ------------------
-  previous_track_controls_view->SetPaintToLayer(ui::LAYER_TEXTURED);
-  previous_track_controls_view->layer()->SetFillsBoundsOpaquely(false);
-  previous_track_controls_view->layer()->SetName("PreviousTrackControlsView");
-
-  // views::View that toggles play/pause/replay. ------------------------------
-  play_pause_controls_view->SetPaintToLayer(ui::LAYER_TEXTURED);
-  play_pause_controls_view->layer()->SetFillsBoundsOpaquely(false);
-  play_pause_controls_view->layer()->SetName("PlayPauseControlsView");
-  play_pause_controls_view->SetPlaybackState(
-      controller_->IsPlayerActive() ? kPlaying : kPaused);
-
-  // views::View that holds the next-track image button. ----------------------
-  next_track_controls_view->SetPaintToLayer(ui::LAYER_TEXTURED);
-  next_track_controls_view->layer()->SetFillsBoundsOpaquely(false);
-  next_track_controls_view->layer()->SetName("NextTrackControlsView");
-
-  replay_10_seconds_button->SetPaintToLayer(ui::LAYER_TEXTURED);
-  replay_10_seconds_button->layer()->SetFillsBoundsOpaquely(false);
-  replay_10_seconds_button->layer()->SetName("Replay10SecondsButton");
-
-  forward_10_seconds_button->SetPaintToLayer(ui::LAYER_TEXTURED);
-  forward_10_seconds_button->layer()->SetFillsBoundsOpaquely(false);
-  forward_10_seconds_button->layer()->SetName("Forward10SecondsButton");
-
-  progress_view->SetPaintToLayer(ui::LAYER_TEXTURED);
-  progress_view->layer()->SetFillsBoundsOpaquely(false);
-  progress_view->layer()->SetName("ProgressView");
-
-  timestamp->SetPaintToLayer(ui::LAYER_TEXTURED);
-  timestamp->layer()->SetFillsBoundsOpaquely(false);
-  timestamp->layer()->SetName("Timestamp");
-
-  live_status->SetPaintToLayer(ui::LAYER_TEXTURED);
-  live_status->layer()->SetFillsBoundsOpaquely(false);
-  live_status->layer()->SetName("LiveStatus");
-
-  live_caption_button->SetPaintToLayer(ui::LAYER_TEXTURED);
-  live_caption_button->layer()->SetFillsBoundsOpaquely(false);
-  live_caption_button->layer()->SetName("LiveCaptionButton");
-
-  live_caption_dialog->SetPaintToLayer(ui::LAYER_TEXTURED);
-  live_caption_dialog->layer()->SetFillsBoundsOpaquely(false);
-  live_caption_dialog->layer()->SetName("LiveCaptionDialog");
-
-  toggle_microphone_button->SetPaintToLayer(ui::LAYER_TEXTURED);
-  toggle_microphone_button->layer()->SetFillsBoundsOpaquely(false);
-  toggle_microphone_button->layer()->SetName("ToggleMicrophoneButton");
-
-  toggle_camera_button->SetPaintToLayer(ui::LAYER_TEXTURED);
-  toggle_camera_button->layer()->SetFillsBoundsOpaquely(false);
-  toggle_camera_button->layer()->SetName("ToggleCameraButton");
-
-  hang_up_button->SetPaintToLayer(ui::LAYER_TEXTURED);
-  hang_up_button->layer()->SetFillsBoundsOpaquely(false);
-  hang_up_button->layer()->SetName("HangUpButton");
-
-#if BUILDFLAG(IS_CHROMEOS)
-  // views::View that shows the affordance that the window can be resized. ----
   resize_handle_view->SetPaintToLayer(ui::LAYER_TEXTURED);
   resize_handle_view->layer()->SetFillsBoundsOpaquely(false);
   resize_handle_view->layer()->SetName("ResizeHandleView");
@@ -1442,12 +1381,14 @@ void VideoOverlayWindowViews::SetUpViews() {
   timestamp_ =
       playback_controls_container_view_->AddChildView(std::move(timestamp));
   live_status_ =
-      playback_controls_container_view_->AddChildView(std::move(live_status));
+      playback_controls_container_view->AddChildView(std::move(live_status));
 
+#if 0
   live_caption_button_ = playback_controls_container_view_->AddChildView(
       std::move(live_caption_button));
   live_caption_dialog_ =
       controls_container_view->AddChildView(std::move(live_caption_dialog));
+#endif
 
   toggle_camera_button_ = vc_controls_container_view_->AddChildView(
       std::move(toggle_camera_button));
@@ -1716,7 +1657,7 @@ void VideoOverlayWindowViews::OnUpdateControlsBounds() {
            .width(),
        kTimestampHeight});
   live_status_->SetVisible(is_live_);
-
+#if 0
   gfx::Rect live_caption_button_bounds(
       bottom_controls_bounds.right() - kBottomControlsHorizontalMargin -
           kActionButtonSize.width(),
@@ -1729,7 +1670,7 @@ void VideoOverlayWindowViews::OnUpdateControlsBounds() {
   live_caption_dialog_->SetPosition(
       {live_caption_button_bounds.right() - live_caption_dialog_->width(),
        live_caption_button_bounds.y() - live_caption_dialog_->height()});
-
+#endif
   // The play/pause button and replay/forward 10 seconds buttons should not be
   // visible while dragging the progress bar or for live media.
   const bool is_dragging_progress_bar =
@@ -2053,6 +1994,7 @@ void VideoOverlayWindowViews::OnGestureEvent(ui::GestureEvent* event) {
     return;
   }
 
+#if 0
   if (live_caption_dialog_ && live_caption_dialog_->GetVisible()) {
     if (!GetLiveCaptionDialogBounds().Contains(event->location())) {
       // Hide the live caption dialog if it's visible and the user taps outside
@@ -2061,11 +2003,11 @@ void VideoOverlayWindowViews::OnGestureEvent(ui::GestureEvent* event) {
       event->SetHandled();
       return;
     }
-
     // Otherwise, let the live caption dialog handle the gesture.
     live_caption_dialog_->OnGestureTapEvent(event);
     return;
   }
+#endif
 
   if (GetBackToTabControlsBounds().Contains(event->location())) {
     controller_->CloseAndFocusInitiator();
@@ -2171,18 +2113,25 @@ gfx::Rect VideoOverlayWindowViews::GetProgressViewBounds() {
 }
 
 gfx::Rect VideoOverlayWindowViews::GetLiveCaptionButtonBounds() {
+#if 0
   return live_caption_button_->GetMirroredBounds();
+#endif
+  return gfx::Rect();
 }
 
 gfx::Rect VideoOverlayWindowViews::GetLiveCaptionDialogBounds() {
+#if 0
   if (!live_caption_dialog_->GetVisible()) {
     return gfx::Rect();
   }
   return live_caption_dialog_->GetMirroredBounds();
+#endif
+  return gfx::Rect();
 }
 
 bool VideoOverlayWindowViews::HasHighMediaEngagement(
     const url::Origin& origin) const {
+#if 0
   MediaEngagementService* service =
       MediaEngagementService::Get(Profile::FromBrowserContext(
           GetController()->GetWebContents()->GetBrowserContext()));
@@ -2191,6 +2140,8 @@ bool VideoOverlayWindowViews::HasHighMediaEngagement(
   }
 
   return service->HasHighEngagement(origin);
+#endif
+  return true;
 }
 
 bool VideoOverlayWindowViews::IsTrustedForMediaPlayback() const {
@@ -2447,16 +2398,20 @@ void VideoOverlayWindowViews::UpdateTimestampLabel(base::TimeDelta current_time,
 }
 
 void VideoOverlayWindowViews::OnLiveCaptionButtonPressed() {
+#if 0
   SetLiveCaptionDialogVisibility(!live_caption_dialog_->GetVisible());
+#endif
 }
 
 void VideoOverlayWindowViews::SetLiveCaptionDialogVisibility(
     bool wanted_visibility) {
+#if 0
   if (wanted_visibility == live_caption_dialog_->GetVisible()) {
     return;
   }
   live_caption_dialog_->SetVisible(wanted_visibility);
   live_caption_button_->SetIsLiveCaptionDialogOpen(wanted_visibility);
+#endif
 
   views::View* controls_to_be_disabled_when_live_caption_is_open[] = {
       minimize_button_.get(),
