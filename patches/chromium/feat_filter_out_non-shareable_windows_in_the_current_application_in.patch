From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Samuel Attard <sattard@salesforce.com>
Date: Thu, 26 May 2022 15:38:32 -0700
Subject: feat: filter out non-shareable windows in the current application in
 ScreenCaptureKitDevice

This patch ensures that windows protected via win.setContentProtection(true) do not appear in full display captures via desktopCapturer.  This patch could be upstreamed but as the check is limited to in-process windows it doesn't make a lot of sense for Chromium itself.  This patch currently has a limitation that it only function for windows created / protected BEFORE the stream is started.  There is theoretical future work we can do via polling / observers to automatically update the SCContentFilter when new windows are made but for now this will solve 99+% of the problem and folks can re-order their logic a bit to get it working for their use cases.

diff --git a/content/browser/media/capture/screen_capture_kit_device_mac.mm b/content/browser/media/capture/screen_capture_kit_device_mac.mm
index d61f64edb0310f19eada7cc85d71942e3499cf98..ea5d9f76364f065e2c57124cc191436eaa731cf7 100644
--- a/content/browser/media/capture/screen_capture_kit_device_mac.mm
+++ b/content/browser/media/capture/screen_capture_kit_device_mac.mm
@@ -122,7 +122,7 @@ bool IsPresenterOverlayLargeActive(CFDictionaryRef attachment) {
 // array containing the SCWindow objects corresponding to the provided IDs.
 // Otherwise, returns an empty array if no matching windows are found.
 API_AVAILABLE(macos(12.3))
-NSArray<SCWindow*>* ConvertWindowIDsToSCWindows(
+NSMutableArray<SCWindow*>* ConvertWindowIDsToSCWindows(
     SCShareableContent* content,
     const std::vector<content::NativeWindowId>& excluded_window_ids) {
   NSMutableArray<SCWindow*>* excluded_sc_windows =
@@ -305,8 +305,32 @@ void OnShareableContentCreated(SCShareableContent* content) {
             std::vector<NativeWindowId> excluded_window_ids =
                 pip_screen_capture_coordinator_proxy_->WindowsToExclude(
                     source_);
-            NSArray<SCWindow*>* excluded_windows =
+            NSMutableArray<SCWindow*>* excluded_windows =
                 ConvertWindowIDsToSCWindows(content, excluded_window_ids);
+            NSArray<NSWindow*>* non_sharing_nswindows = [[[NSApplication
+                sharedApplication] windows]
+                filteredArrayUsingPredicate:[NSPredicate
+                                                predicateWithBlock:^BOOL(
+                                                    NSWindow* win,
+                                                    NSDictionary* bindings) {
+                                                  return [win sharingType] ==
+                                                         NSWindowSharingNone;
+                                                }]];
+            NSArray<SCWindow*>* non_sharing_scwindows = [[content windows]
+                filteredArrayUsingPredicate:
+                    [NSPredicate predicateWithBlock:^BOOL(
+                                     SCWindow* win, NSDictionary* bindings) {
+                      for (NSWindow* excluded : non_sharing_nswindows) {
+                        if ((CGWindowID)[excluded windowNumber] ==
+                            [win windowID]) {
+                          return true;
+                        }
+                      }
+                      return false;
+                    }]];
+            // Combine excluded windows from PiP and non-shareable windows.
+            [excluded_windows addObjectsFromArray:non_sharing_scwindows];
+
             filter = [[SCContentFilter alloc] initWithDisplay:display
                                              excludingWindows:excluded_windows];
             stream_config_content_size_ =
