From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Shelley Vohr <shelley.vohr@gmail.com>
Date: Tue, 18 Mar 2025 10:41:27 +0100
Subject: fix: ensure TraverseParent bails on resource path exit

Electron's security model requires that we do not traverse outside of the
resource path. This commit ensures that the TraverseParent function
bails out if the parent path is outside of the resource path.

diff --git a/src/node_modules.cc b/src/node_modules.cc
index df9925404e77ec61900f89a5241c86a599e548c5..b5425122b54d91673e184ccfe88dd3a0ca2ff634 100644
--- a/src/node_modules.cc
+++ b/src/node_modules.cc
@@ -333,8 +333,41 @@ const BindingData::PackageConfig* BindingData::TraverseParent(
     Realm* realm, const std::filesystem::path& check_path) {
   std::filesystem::path current_path = check_path;
   auto env = realm->env();
+  Isolate* isolate = env->isolate();
   const bool is_permissions_enabled = env->permission()->enabled();
 
+  // Get the resources path with trailing slash.
+  std::string resources_path;
+  {
+    HandleScope handle_scope(isolate);
+    Local<Value> resources_path_value;
+    Local<Object> process_object = env->process_object();
+
+    Local<String> resources_path_key =
+        String::NewFromUtf8Literal(isolate, "resourcesPath");
+    if (process_object->Get(env->context(), resources_path_key)
+            .ToLocal(&resources_path_value) &&
+        resources_path_value->IsString()) {
+      resources_path = *String::Utf8Value(isolate, resources_path_value);
+      if (!resources_path.empty() && !resources_path.ends_with(kPathSeparator)) {
+        resources_path += kPathSeparator;
+      }
+    }
+  }
+
+  auto starts_with = [](const std::string& str, const std::string& prefix) -> bool {
+    if (prefix.size() > str.size()) return false;
+    return std::equal(
+        prefix.begin(), prefix.end(), str.begin(),
+        [](char a, char b) {
+          return std::tolower(static_cast<unsigned char>(a)) ==
+                std::tolower(static_cast<unsigned char>(b));
+        });
+  };
+
+  bool did_original_path_start_with_resources_path = starts_with(
+      ConvertGenericPathToUTF8(check_path), resources_path);
+
   do {
     current_path = current_path.parent_path();
 
@@ -354,6 +387,12 @@ const BindingData::PackageConfig* BindingData::TraverseParent(
       }
     }
 
+    // If current path is outside the resources path, bail.
+    if (did_original_path_start_with_resources_path &&
+        !starts_with(ConvertGenericPathToUTF8(current_path), resources_path)) {
+      return nullptr;
+    }
+
     // Check if the path ends with `/node_modules`
     if (current_path.filename() == "node_modules") {
       return nullptr;
